<?php

/**
 * EventTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class EventTable extends Doctrine_Table {

	public static function getInstance() { return Doctrine_Core::getTable('Event'); }

	public function getEventsForPage($page = 0) {

		if($page == 0) {

			$events = $this->createQuery('a')
			->orderBy('start_date')
			->execute();
		}
		else {

			// TODO: calculate referal hour from $page variable

			$sql = 'SELECT * FROM event e WHERE e.start_date <= ADDDATE(e.start_date, INTERVAL 3 HOUR)';
	/*
			$date_start = $page * 

			$events = $this->createQuery('a')
			->
	*/
		}

		return $events;
	}

	// user-to-event getters
	public function getForUser(sfUser $user) {

		return $user->getGuardUser()->getOrganiser()->getEvents();
	}
	public function getAPIForUser(sfUser $user) {

		return $user->getMelody('eventbrite')->getEventsForUser($user->getGuardUser()->getEmailAddress());
	}
	public function getAPIUnhostedForUser(sfUser $user) {

		// fetch stuff from API
		$eventsAPI = $this->getAPIForUser($user);

		// 1a. check if user has anything in the API
		if($eventsAPI and is_array($eventsAPI) and isset($eventsAPI['events']) and count($eventsAPI['events'])) {

			// fetch stuff from local DB
			$eventsDB = $this->getForUser($user);

			// 2. check if the user has any events hosted in our database
			if($eventsDB and count($eventsDB)) {

				// 3a. TODO: rule out duplicates
			}

			// 3b. return all of the API events
			else return $eventsAPI['events'];
		}

		// 1b. return false
		else return false;
	}

}
